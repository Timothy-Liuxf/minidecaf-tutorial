# 类型系统

相信大家都了解过编程语言中**类型**的概念，数据的类型描述了数据的“含义”，描述了编译器和解释器会如何使用这份数据，比如在 C 语言中，下标运算只能应用于数组类型或指针类型。
C 编译器会检查下标运算所应用的表达式的类型，如果它不是数组类型或者指针类型，比如 `int a; a[3];`，C 编译器就会认为其无法被应用于下标运算，继而报出一个编译错误。
除了数据类型之外，人们同样也会讨论函数类型，但由于 MiniDecaf 几乎不支持任何函数式特性，简单起见，这里我们所讨论的类型仅包含数据类型。

将一种语言中的所有类型及对各种类型的所有使用规则形式化，严格地描述语言中如何为每个表达式指定类型，这就构成了**类型系统**。
类型系统包含若干条类型规则，每条规则描述了如何为一种表达式指定类型。
一条类型规则形如

$$
\frac{p_1 \qquad \cdots \qquad p_m}{e : t}
$$

，其中 $$e : t$$ 指表达式 $$e$$ 的类型为 $$t$$，这条规则的含义（读法）为当横线上方的前提条件 $$p_1 \cdots p_m$$ 都被满足时横线下方的结论成立。
MiniDecaf 的类型系统将会在之后详尽列出。

基于类型系统，我们便可以通过自底向上地遍历 AST 来做**类型检查**，即对于一个表达式，尝试找到符合子表达式类型及运算的类型规则，通过找到的类型规则来推导出这个表达式的类型；如果没有符合的类型规则，则报出一个类型错误。
通过类型检查，编译器可以很好地减少程序中可能的 bug。
类型检查可以放在编译时（静态）或者运行时（动态）执行，或者在编译时和运行时都执行。

## MiniDecaf 的类型系统

MiniDecaf 包含两种类型：
- $$\mathrm{int}$$：一个 32 位整数；
- $$[\mathrm{int}]^n$$：一个 $$n~(n \ge 1)$$ 维数组，其元素类型为 $$\mathrm{int}$$。

MiniDecaf 包含五条类型规则：

$$
\frac
{e : \mathrm{int} \qquad \bullet \in UN}
{\bullet (e) : \mathrm{int}}
\text{(T-un)}
$$

第一条规则是对一元运算的结果的指定规则，其中 $$UN$$ 是 MiniDecaf 中所有的一元运算集合，$$\bullet(e)$$ 表示将 $$\bullet$$ 这个运算应用于 $$e$$ 上所得的结果。
直观来讲，即是说当一元运算的操作数是一个 $$\mathrm{int}$$ 时，该操作的结果也是一个 $$\mathrm{int}$$。

$$
\frac
{e_1 : \mathrm{int} \qquad e_2 : \mathrm{int} \qquad \bullet \in BIN}
{\bullet (e_1, e_2) : \mathrm{int}}
\text{(T-bin)}
$$

第二条规则是对二元运算的结果的指定规则，其中 $$BIN$$ 是 MiniDecaf 中除了下标运算以外的所有的二元运算集合，$$\bullet(e_1, e_2)$$ 表示将 $$\bullet$$ 这个运算应用于 $$e_1$$ 和 $$e_2$$ 上所得的结果。
直观来讲，即是说当一个不是下标运算的二元运算的操作数都是一个 $$\mathrm{int}$$ 时，该操作的结果也是一个 $$\mathrm{int}$$。

$$
\frac
{e_1 : \mathrm{int} \qquad e_2 : \mathrm{int} \qquad e_3 : \mathrm{int} \qquad \bullet \in TERN}
{\bullet(e_1, e_2, e_3) : \mathrm{int}}
\text{(T-tern)}
$$

第三条规则是对三元运算的结果的指定规则，其中 $$BIN$$ 是 MiniDecaf 中所有的三元运算集合，$$\bullet(e_1, e_2, e_3)$$ 表示将 $$\bullet$$ 这个运算应用于 $$e_1$$、$$e_2$$ 和 $$e_3$$ 上所得的结果。
直观来讲，即是说当一个三元运算的操作数都是一个 $$\mathrm{int}$$ 时，该操作的结果也是一个 $$\mathrm{int}$$。

$$
\frac
{a : [\mathrm{int}]^n \qquad i : \mathrm{int} \qquad n > 1}
{a[i] : [\mathrm{int}]^{n-1}}
\text{(T-hda)}
$$

第四条规则是对高维数组（维数大于 1）的下标运算的结果的指定规则。
直观来讲，即是说当下标运算被应用于一个高维数组且下标为 $$\mathrm{int}$$ 时，其运算结果是一个比原数组低一维的数组。

$$
\frac
{a : [\mathrm{int}]^1 \qquad i : \mathrm{int}}
{a[i]: \mathrm{int}}
\text{(T-oda)}
$$

第五条规则是对一维数组的下标运算的结果的指定规则，其运算结果是一个整数。
直观来讲，即是说当下标运算被应用于一个一维数组且下标为 $$\mathrm{int}$$ 时，其运算结果是一个 $$\mathrm{int}$$。

另外，对于仅包含单个变量或者函数调用的表达式 $$e$$，我们有 $$e : \mathrm{int}$$。
